{% extends 'base.html.twig' %}

{% block title %}Biblioth√®que - Liste des Books{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-r from-indigo-100 via-white to-indigo-100 py-12 px-6 flex flex-col items-center">

  <!-- Header avec title principal -->
  <header class="max-w-6xl w-full mb-12 text-center px-4 sm:px-0">
    <h1 class="text-6xl sm:text-7xl font-extrabold text-indigo-900 mb-4 drop-shadow-lg leading-tight">
      Liste des Books
    </h1>
    <p class="text-xl text-indigo-700 max-w-3xl mx-auto">
      D√©couvrez notre s√©lection de livres disponibles.
    </p>
  </header>
    <!-- Filtres par Cat√©gorie et Genre -->
    <section class="max-w-6xl w-full mb-8 px-4 sm:px-0">
        <form method="get" action="" class="bg-white p-6 rounded-xl shadow-md grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">

            <div>
                <label for="category" class="block text-sm font-semibold text-indigo-700 mb-1">Cat√©gorie</label>
                <select name="category" id="category" class="w-full rounded-lg border border-indigo-300 p-2">
                    <option value="">-- Toutes --</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {{ app.request.get('category') == category.id ? 'selected' }}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="genre" class="block text-sm font-semibold text-indigo-700 mb-1">Genre</label>
                <select name="genre" id="genre" class="w-full rounded-lg border border-indigo-300 p-2">
                    <option value="">-- Tous --</option>
                    {% for genre in genres %}
                        <option value="{{ genre.id }}" {{ app.request.get('genre') == genre.id ? 'selected' }}>
                            {{ genre.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex items-end">
                <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg py-2 px-4 transition-colors w-full">
                    Filtrer
                </button>
            </div>

        </form>
    </section>


    <!-- Grille des livres -->
  <main class="max-w-6xl w-full grid gap-8 sm:gap-10 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 justify-center">

    {% if books|length > 0 %}
      {% set shuffledBooks = books|shuffle %}

      {% for book in shuffledBooks|slice(0, 50) %}
        <article class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300 flex flex-col overflow-hidden group max-w-xs w-full mx-auto">

          <div class="relative h-48 overflow-hidden rounded-t-2xl bg-indigo-50">
            {% if book.coverImage %}
              <img
                src="{{ asset('images/' ~ book.coverImage) }}"
                alt="Couverture du livre {{ book.title }}"
                class="object-cover w-full h-full transform group-hover:scale-105 transition-transform duration-300"
              >
            {% else %}
              <div class="flex items-center justify-center h-full text-indigo-400 text-7xl font-bold select-none">
                üìö
              </div>
            {% endif %}
            <span
              class="absolute top-3 right-3 px-3 py-1 text-xs font-semibold rounded-full
                     {{ book.available ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900' }}"
              title="{{ book.available ? 'Available √† l‚Äôemprunt' : 'Inavailable actuellement' }}"
            >
              {{ book.available ? 'Available' : 'Emprunt√©' }}
            </span>
          </div>

          <div class="p-4 flex flex-col flex-grow overflow-visible">
            <h2
              class="text-lg sm:text-xl font-extrabold text-indigo-900 mb-1"
              title="{{ book.title }}"
            >
              {{ book.title }}
            </h2>

            <p class="text-xs sm:text-sm text-indigo-700 mb-1 font-semibold" title="Auteurs">
              <span class="opacity-75">Auteur{{ book.authors|length > 1 ? 's' : '' }} :</span>
              {% if book.authors|length > 0 %}
                {{ book.authors|map(a => a.fullname)|join(', ') }}
              {% else %}
                <em>Non renseign√©</em>
              {% endif %}
            </p>

            <p class="text-xs sm:text-sm text-indigo-600 mb-3" title="Cat√©gorie">
              <span class="opacity-75">Cat√©gorie{{ book.categories|length > 1 ? 's' : '' }} :</span>
              {% if book.categories|length > 0 %}
                {{ book.categories|map(c => c.name)|join(', ') }}
              {% else %}
                <em>Inconnue</em>
              {% endif %}
            </p>

            {% if book.available %}
              <form method="post" action="{{ path('app_book_emprunter', {'id': book.id}) }}" class="mt-auto mb-2">
                <input type="hidden" name="_token" value="{{ csrf_token('emprunter' ~ book.id) }}">
                <button
                  type="submit"
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg py-2 text-sm transition-colors"
                >
                  Emprunter
                </button>
              </form>
            {% else %}
              <div class="mt-auto py-2 text-center text-red-600 font-semibold text-sm select-none">
                Inavailable
              </div>
            {% endif %}

            {% if app.user %}
              {% set isFavorite = book in app.user.getFavorite() %}
              {% if isFavorite %}
                <div class="mt-2 text-center text-green-700 font-semibold text-sm select-none">
                  ‚≠ê Favori
                </div>
              {% else %}
                <form method="post" action="{{ path('app_favorite_add', {'id': book.id}) }}" class="mt-auto">
                  <input type="hidden" name="_token" value="{{ csrf_token('add_favori' ~ book.id) }}">
                  <button
                    type="submit"
                    class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-semibold rounded-lg py-2 text-sm transition-colors"
                  >
                    Ajouter aux favoris
                  </button>
                </form>
              {% endif %}
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="col-span-full text-center text-indigo-500 text-lg mt-16">
        Aucun livre available pour le moment.
      </p>
    {% endif %}

  </main>
</div>
{% endblock %}
